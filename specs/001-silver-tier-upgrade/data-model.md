# Data Model: Silver Tier Upgrade

**Feature**: 001-silver-tier-upgrade | **Date**: 2026-02-15
**Purpose**: Define entities, relationships, state transitions, and validation rules

## Entities

### 1. Task

**Description**: Represents work to be done by the AI Employee. Tasks move through folders representing state transitions.

**Fields**:
- `id` (string): Unique identifier (timestamp-based: `YYYYMMDD-HHMMSS-<slug>`)
- `title` (string): Human-readable task description
- `status` (enum): Current state - `new`, `triaged`, `planned`, `pending_approval`, `approved`, `rejected`, `completed`, `failed`
- `created_at` (ISO 8601 datetime): Task creation timestamp
- `updated_at` (ISO 8601 datetime): Last modification timestamp
- `priority` (enum): `P1` (urgent), `P2` (high), `P3` (normal), `P4` (low)
- `source` (enum): `manual` (user-created), `email` (Gmail watcher), `scheduled` (reasoning loop)
- `email_source` (boolean): True if task originated from email
- `original_email_id` (string, optional): Email UID for tracking
- `content` (markdown): Task description and details
- `error_message` (string, optional): Error details if processing failed
- `retry_count` (integer): Number of retry attempts (default: 0)

**Validation Rules**:
- `id` must be unique across all tasks
- `title` must be non-empty, max 200 characters
- `created_at` and `updated_at` must be valid ISO 8601 timestamps
- `priority` defaults to `P3` if not specified
- `source` defaults to `manual` if not specified
- `retry_count` must be non-negative, max 5

**State Transitions**:
```
new (Inbox)
  → triaged (Needs_Action) [manual or reasoning loop]
  → planned (Plans or Pending_Approval) [reasoning loop generates plan]
  → approved (Approved) [human approval for external actions]
  → completed (Done) [successful execution]

Alternative paths:
  → rejected (Rejected) [human denial]
  → failed (Needs_Action with error) [execution failure]
```

**File Location**: Folder determines state
- `/Inbox` → status: `new`
- `/Needs_Action` → status: `triaged`
- `/Plans` → status: `planned` (file-only actions)
- `/Pending_Approval` → status: `pending_approval` (external actions)
- `/Approved` → status: `approved`
- `/Rejected` → status: `rejected`
- `/Done` → status: `completed`

---

### 2. Plan

**Description**: Structured execution plan generated by reasoning loop. Determines routing based on action types.

**Fields**:
- `id` (string): Unique identifier (matches source task ID)
- `task_id` (string): Reference to originating task
- `objective` (string): Clear statement of what the plan achieves
- `steps` (array of objects): Ordered execution steps
  - `step_number` (integer): Sequential step identifier
  - `action` (string): Description of action to perform
  - `action_type` (enum): `file_read`, `file_write`, `file_move`, `send_email`, `post_facebook`
  - `parameters` (object): Action-specific parameters
  - `expected_outcome` (string): What success looks like
- `requires_approval` (boolean): True if any step has external action_type
- `risks` (array of strings): Potential failure modes
- `rollback_procedure` (string): Steps to undo changes if execution fails
- `created_at` (ISO 8601 datetime): Plan generation timestamp
- `approved_at` (ISO 8601 datetime, optional): Human approval timestamp
- `approved_by` (string, optional): User identifier (default: "human")
- `executed_at` (ISO 8601 datetime, optional): Execution start timestamp
- `completed_at` (ISO 8601 datetime, optional): Execution completion timestamp
- `execution_status` (enum): `pending`, `in_progress`, `completed`, `failed`
- `execution_summary` (string, optional): Results of execution

**Validation Rules**:
- `objective` must be non-empty, max 500 characters
- `steps` must contain at least 1 step, max 20 steps
- `requires_approval` automatically set to true if any step has `send_email` or `post_facebook` action_type
- `risks` must contain at least 1 risk if `requires_approval` is true
- `rollback_procedure` required if `requires_approval` is true
- `approved_at` and `approved_by` required if plan moved to Approved folder

**Routing Logic**:
```python
if plan.requires_approval:
    destination = "/Pending_Approval"
else:
    destination = "/Plans"
```

**File Location**: Folder determines approval state
- `/Plans` → File-only actions, ready for execution
- `/Pending_Approval` → External actions, awaiting human review
- `/Approved` → Human-approved, ready for execution
- `/Rejected` → Human-denied, will not execute
- `/Done` → Execution completed

---

### 3. Approval Request

**Description**: Plan requiring human review before execution. Stored in Pending_Approval folder.

**Fields**:
- `plan_id` (string): Reference to plan requiring approval
- `action_preview` (object): Human-readable preview of external actions
  - `email_preview` (object, optional):
    - `to` (string): Recipient email address
    - `subject` (string): Email subject line
    - `body` (string): Email body content (first 500 chars)
  - `facebook_preview` (object, optional):
    - `page_name` (string): Target Facebook Page name
    - `message` (string): Post content (full text)
- `risks_summary` (string): Concise risk assessment for human review
- `approval_instructions` (string): How to approve or reject
- `created_at` (ISO 8601 datetime): Request creation timestamp
- `expires_at` (ISO 8601 datetime, optional): Approval deadline (null = no expiration)

**Validation Rules**:
- `plan_id` must reference existing plan
- `action_preview` must contain at least one preview object (email or facebook)
- `risks_summary` must be non-empty, max 1000 characters
- `approval_instructions` must include folder movement instructions

**Human Actions**:
- **Approve**: Move file from `/Pending_Approval` to `/Approved`
- **Reject**: Move file from `/Pending_Approval` to `/Rejected`
- **Modify**: Edit plan content, keep in `/Pending_Approval` for re-review

---

### 4. Agent Skill

**Description**: Modular AI capability stored in Skills folder. Defines permissions and execution logic.

**Fields**:
- `skill_name` (string): Unique skill identifier (e.g., `planner_skill`, `email_skill`)
- `description` (string): Human-readable skill purpose
- `version` (string): Semantic version (e.g., `1.0.0`)
- `required_permissions` (array of strings): Permissions needed (e.g., `file_read`, `file_write`, `mcp_email`)
- `external_dependencies` (array of strings): External services required (e.g., `mcp_server`, `gmail_imap`)
- `requires_approval` (boolean): True if skill performs external actions
- `error_handling` (object):
  - `retry_strategy` (enum): `none`, `exponential_backoff`, `circuit_breaker`
  - `max_retries` (integer): Maximum retry attempts
  - `fallback_action` (string): What to do if all retries fail
- `rollback_procedure` (string): How to undo skill execution
- `execution_logic` (markdown): Detailed skill implementation instructions

**Validation Rules**:
- `skill_name` must be unique, lowercase with underscores
- `version` must follow semantic versioning (MAJOR.MINOR.PATCH)
- `required_permissions` must be non-empty array
- `requires_approval` must be true if `required_permissions` includes `mcp_*` permissions
- `error_handling.max_retries` must be 0-5

**Predefined Skills**:
1. **planner_skill**: Generates execution plans from tasks
2. **email_skill**: Composes and sends emails via MCP
3. **facebook_skill**: Composes and posts to Facebook Pages via MCP

---

### 5. MCP Server Configuration

**Description**: Settings for external integrations. Stored in mcp_server folder.

**Fields**:
- `server_name` (string): Always `silver_tier_mcp`
- `version` (string): MCP server version
- `enabled_functions` (array of strings): Active MCP functions (e.g., `send_email`, `post_facebook_page`)
- `email_config` (object):
  - `smtp_host` (string): SMTP server hostname
  - `smtp_port` (integer): SMTP server port
  - `smtp_use_tls` (boolean): Enable TLS encryption
  - `from_address` (string): Sender email address
  - `credentials_env_var` (string): Environment variable name for password
- `facebook_config` (object):
  - `api_version` (string): Meta Graph API version (e.g., `v18.0`)
  - `page_id_env_var` (string): Environment variable name for Page ID
  - `access_token_env_var` (string): Environment variable name for Page Access Token
- `rate_limits` (object):
  - `email_per_hour` (integer): Max emails per hour
  - `facebook_per_hour` (integer): Max Facebook posts per hour
- `logging` (object):
  - `log_level` (enum): `DEBUG`, `INFO`, `WARNING`, `ERROR`
  - `log_file_path` (string): Path to log file
  - `log_retention_days` (integer): Days to keep logs

**Validation Rules**:
- `enabled_functions` must be subset of `[send_email, post_facebook_page]`
- `email_config.smtp_port` must be 1-65535
- `facebook_config.api_version` must match pattern `v\d+\.\d+`
- `rate_limits` values must be positive integers
- `logging.log_retention_days` must be 1-365

**Security**:
- Credentials NEVER stored in config file
- All sensitive values referenced via environment variables
- Config file version-controlled, `.env` file excluded

---

### 6. Watcher

**Description**: Background process monitoring specific folder for file changes.

**Fields**:
- `watcher_name` (string): Unique identifier (e.g., `inbox_watcher`, `gmail_watcher`)
- `monitored_folder` (string): Absolute path to watched folder
- `responsibility` (string): Single, well-defined purpose
- `file_pattern` (string): File extension filter (e.g., `*.md`)
- `event_types` (array of strings): Events to monitor (e.g., `created`, `modified`, `moved`)
- `handler_function` (string): Function to call on event detection
- `debounce_seconds` (integer): Wait time after last change before processing
- `state_file_path` (string): Path to watcher state persistence file
- `last_processed_timestamp` (ISO 8601 datetime): Last successful processing time
- `error_count` (integer): Consecutive error count (for circuit breaker)
- `status` (enum): `running`, `stopped`, `error`, `circuit_open`

**Validation Rules**:
- `watcher_name` must be unique
- `monitored_folder` must exist and be within vault boundary
- `debounce_seconds` must be 0-60
- `error_count` resets to 0 on successful processing
- `status` transitions to `circuit_open` after 5 consecutive errors

**Watcher Instances**:
1. **inbox_watcher**: Monitors `/Inbox` for new task files
2. **gmail_watcher**: Monitors Gmail IMAP for new emails
3. **pending_approval_watcher**: Monitors `/Pending_Approval` for new approval requests
4. **approved_watcher**: Monitors `/Approved` for human-approved plans

---

### 7. Execution Log

**Description**: Record of reasoning loop activities. Daily log file in mcp_server/logs/.

**Fields**:
- `log_date` (ISO 8601 date): Log file date (YYYY-MM-DD)
- `entries` (array of objects): Log entries for the day
  - `timestamp` (ISO 8601 datetime): Entry creation time
  - `event_type` (enum): `reasoning_loop_start`, `reasoning_loop_end`, `task_processed`, `plan_generated`, `plan_executed`, `error`, `watcher_event`
  - `task_id` (string, optional): Related task identifier
  - `plan_id` (string, optional): Related plan identifier
  - `message` (string): Human-readable log message
  - `details` (object, optional): Structured event details
  - `error_details` (object, optional): Error information if event_type is `error`
    - `error_type` (string): Error classification
    - `error_message` (string): Error description
    - `stack_trace` (string): Full stack trace

**Validation Rules**:
- `log_date` must be valid ISO 8601 date
- `timestamp` must be within log_date day
- `message` must be non-empty, max 2000 characters
- `error_details` required if `event_type` is `error`

**File Naming**: `execution-log-YYYY-MM-DD.json`

**Retention**: Logs kept for 30 days, then archived or deleted

---

## Relationships

```
Task (1) ──generates──> (1) Plan
Plan (1) ──creates──> (0..1) Approval Request
Plan (1) ──references──> (1..*) Agent Skill
Agent Skill (1..*) ──uses──> (1) MCP Server Configuration
Watcher (4) ──monitors──> (1..*) Task/Plan files
Execution Log (1 per day) ──records──> (1..*) Task/Plan events
```

---

## State Transition Diagram

```
[User creates task]
        ↓
    ┌───────┐
    │ Inbox │ (status: new)
    └───┬───┘
        ↓ [Inbox watcher detects]
┌───────────────┐
│ Needs_Action  │ (status: triaged)
└───────┬───────┘
        ↓ [Reasoning loop processes]
        ├─→ [File-only actions] ─→ ┌───────┐
        │                          │ Plans │ (status: planned)
        │                          └───┬───┘
        │                              ↓ [Execute immediately]
        │                          ┌──────┐
        │                          │ Done │ (status: completed)
        │                          └──────┘
        │
        └─→ [External actions] ─→ ┌───────────────────┐
                                  │ Pending_Approval  │ (status: pending_approval)
                                  └─────────┬─────────┘
                                            ↓ [Human reviews]
                                    ┌───────┴───────┐
                                    ↓               ↓
                            ┌──────────┐    ┌──────────┐
                            │ Approved │    │ Rejected │
                            └────┬─────┘    └──────────┘
                                 ↓
                            [Execute via MCP]
                                 ↓
                            ┌──────┐
                            │ Done │ (status: completed)
                            └──────┘
```

---

## File Format Standards

### Task File Example

```markdown
---
id: "20260215-143000-send-weekly-report"
title: "Send weekly report to team"
status: "triaged"
created_at: "2026-02-15T14:30:00Z"
updated_at: "2026-02-15T14:30:00Z"
priority: "P2"
source: "manual"
email_source: false
retry_count: 0
---

# Task: Send weekly report to team

Send the weekly project status report to the team via email.

**Recipients**: team@example.com
**Subject**: Weekly Project Status - Week of Feb 15
**Content**: Include completed tasks, blockers, and next week's priorities.
```

### Plan File Example

```markdown
---
id: "20260215-143000-send-weekly-report"
task_id: "20260215-143000-send-weekly-report"
objective: "Send weekly project status report to team@example.com"
requires_approval: true
created_at: "2026-02-15T14:35:00Z"
execution_status: "pending"
---

# Execution Plan: Send weekly report to team

## Steps

1. **Read completed tasks from Done folder** (action_type: file_read)
   - Parameters: folder="/Done", date_range="2026-02-08 to 2026-02-15"
   - Expected outcome: List of completed tasks with titles and dates

2. **Compose email content** (action_type: file_write)
   - Parameters: template="weekly_report", data=completed_tasks
   - Expected outcome: Formatted email body with task summary

3. **Send email via MCP** (action_type: send_email)
   - Parameters: to="team@example.com", subject="Weekly Project Status - Week of Feb 15", body=<composed_content>
   - Expected outcome: Email delivered successfully

## Risks

- Email delivery failure due to SMTP server issues
- Recipient email address may be invalid
- Email content may be incomplete if Done folder is empty

## Rollback Procedure

If email sending fails:
1. Log error details in plan frontmatter
2. Move plan back to Pending_Approval with error message
3. Notify human via pending_approval_watcher
4. Human can modify recipient or retry

## Action Preview

**Email Preview**:
- To: team@example.com
- Subject: Weekly Project Status - Week of Feb 15
- Body: (first 500 chars)
  "Hi team, here's our weekly project status update..."
```

---

## Validation Summary

All entities must pass validation before state transitions:
- **Task**: Valid ID, non-empty title, valid timestamps
- **Plan**: At least 1 step, risks documented if requires_approval
- **Approval Request**: Valid action preview, non-empty risks
- **Agent Skill**: Unique name, valid permissions, error handling defined
- **MCP Config**: Valid rate limits, credentials via env vars only
- **Watcher**: Unique name, folder within vault boundary
- **Execution Log**: Valid timestamps, error details if error event

Invalid entities remain in current state with error logged in frontmatter.
