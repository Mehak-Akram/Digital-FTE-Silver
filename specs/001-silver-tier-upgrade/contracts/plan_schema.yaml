# Plan File Format Specification
# Silver Tier Upgrade - Plan.md YAML Frontmatter Schema

schema_version: "1.0.0"
description: "Defines the structure and validation rules for Plan.md files generated by the reasoning loop"

frontmatter:
  type: object
  required:
    - id
    - task_id
    - objective
    - requires_approval
    - created_at
    - execution_status

  properties:
    id:
      type: string
      pattern: '^\d{8}-\d{6}-.+$'
      description: "Unique plan identifier (format: YYYYMMDD-HHMMSS-slug)"
      examples:
        - "20260215-143000-send-weekly-report"

    task_id:
      type: string
      pattern: '^\d{8}-\d{6}-.+$'
      description: "Reference to originating task ID"
      examples:
        - "20260215-143000-send-weekly-report"

    objective:
      type: string
      minLength: 1
      maxLength: 500
      description: "Clear statement of what the plan achieves"
      examples:
        - "Send weekly project status report to team@example.com"

    requires_approval:
      type: boolean
      description: "True if plan contains external actions (send_email, post_facebook)"
      default: false

    created_at:
      type: string
      format: date-time
      description: "ISO 8601 timestamp of plan generation"
      examples:
        - "2026-02-15T14:35:00Z"

    approved_at:
      type: string
      format: date-time
      description: "ISO 8601 timestamp of human approval (required if in Approved folder)"
      examples:
        - "2026-02-15T15:00:00Z"

    approved_by:
      type: string
      description: "User identifier who approved the plan"
      default: "human"
      examples:
        - "human"
        - "john.doe"

    executed_at:
      type: string
      format: date-time
      description: "ISO 8601 timestamp when execution started"
      examples:
        - "2026-02-15T15:05:00Z"

    completed_at:
      type: string
      format: date-time
      description: "ISO 8601 timestamp when execution completed"
      examples:
        - "2026-02-15T15:07:00Z"

    execution_status:
      type: string
      enum:
        - pending
        - in_progress
        - completed
        - failed
      description: "Current execution state"
      default: pending

    execution_summary:
      type: string
      maxLength: 5000
      description: "Results of execution (populated after completion)"
      examples:
        - "Email sent successfully to team@example.com. Message ID: <abc123@smtp.example.com>"

    error_message:
      type: string
      maxLength: 2000
      description: "Error details if execution failed"
      examples:
        - "SMTP connection error: Connection refused on port 587"

    retry_count:
      type: integer
      minimum: 0
      maximum: 5
      description: "Number of execution retry attempts"
      default: 0

content_body:
  type: markdown
  required_sections:
    - steps
    - risks
    - rollback_procedure

  optional_sections:
    - action_preview

  sections:
    steps:
      description: "Ordered list of execution steps"
      format: "Numbered list with step details"
      required_fields:
        - action_description
        - action_type
        - parameters
        - expected_outcome

      action_types:
        - file_read
        - file_write
        - file_move
        - file_delete
        - send_email
        - post_facebook

      example: |
        ## Steps

        1. **Read completed tasks from Done folder** (action_type: file_read)
           - Parameters: folder="/Done", date_range="2026-02-08 to 2026-02-15"
           - Expected outcome: List of completed tasks with titles and dates

        2. **Send email via MCP** (action_type: send_email)
           - Parameters: to="team@example.com", subject="Weekly Status", body=<content>
           - Expected outcome: Email delivered successfully

    risks:
      description: "Potential failure modes and their impact"
      format: "Bulleted list of risks"
      required_if: requires_approval is true
      minimum_items: 1

      example: |
        ## Risks

        - Email delivery failure due to SMTP server issues
        - Recipient email address may be invalid
        - Email content may be incomplete if Done folder is empty

    rollback_procedure:
      description: "Steps to undo changes if execution fails"
      format: "Numbered list or prose description"
      required_if: requires_approval is true

      example: |
        ## Rollback Procedure

        If email sending fails:
        1. Log error details in plan frontmatter
        2. Move plan back to Pending_Approval with error message
        3. Notify human via pending_approval_watcher
        4. Human can modify recipient or retry

    action_preview:
      description: "Human-readable preview of external actions for approval"
      format: "Structured preview with action details"
      required_if: requires_approval is true

      email_preview:
        fields:
          - to
          - subject
          - body (first 500 characters)

      facebook_preview:
        fields:
          - page_name
          - message (full text)

      example: |
        ## Action Preview

        **Email Preview**:
        - To: team@example.com
        - Subject: Weekly Project Status - Week of Feb 15
        - Body: (first 500 chars)
          "Hi team, here's our weekly project status update..."

validation_rules:
  - rule: "If requires_approval is true, plan MUST be routed to Pending_Approval folder"
  - rule: "If requires_approval is false, plan MUST be routed to Plans folder"
  - rule: "approved_at and approved_by MUST be set when plan moves to Approved folder"
  - rule: "execution_status MUST be 'in_progress' when executed_at is set"
  - rule: "execution_status MUST be 'completed' or 'failed' when completed_at is set"
  - rule: "If any step has action_type 'send_email' or 'post_facebook', requires_approval MUST be true"
  - rule: "risks section MUST contain at least 1 risk if requires_approval is true"
  - rule: "rollback_procedure MUST be non-empty if requires_approval is true"
  - rule: "action_preview MUST be present if requires_approval is true"

file_naming:
  pattern: "{id}.md"
  examples:
    - "20260215-143000-send-weekly-report.md"

file_location:
  routing_logic: |
    if plan.requires_approval:
        destination = "/Pending_Approval"
    else:
        destination = "/Plans"

  folders:
    - path: "/Plans"
      description: "File-only actions, ready for immediate execution"
    - path: "/Pending_Approval"
      description: "External actions, awaiting human review"
    - path: "/Approved"
      description: "Human-approved plans, ready for execution"
    - path: "/Rejected"
      description: "Human-rejected plans, will not execute"
    - path: "/Done"
      description: "Completed plans with execution summary"
